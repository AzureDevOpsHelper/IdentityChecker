# IdentityChecker

IdentityChecker is a small PowerShell helper script that gathers information about an Azure DevOps user and the corresponding Microsoft Entra (Azure AD) account, then checks for common identity mismatches and known issues that can cause login, authorization, or invitation problems.

**Quick summary:** The script fetches access tokens (Graph and DevOps), reads Entra and Azure DevOps user records for a given UPN, and runs a set of checks (UPN casing, object id, tenant id, user type, guest roles, and guest email/UPN mismatches).

**Features**
- **Collects Entra (Microsoft Graph) user information**: UPN, email, object id, creation type, external user state, and 'Guest Inviter' role.
- **Collects Azure DevOps identity information**: VSID, tenant id, account name, email, object id, and meta type.
- **Automated checks**: Compares UPN casing, OID, tenant id, user type, guest inviter role, and guest email/UPN mismatches and prints clear actionable guidance.

**Prerequisites**
- **PowerShell** (Windows PowerShell or PowerShell Core). Script is written for common PowerShell on Windows.
- **Az PowerShell module** (the script will attempt to install the `Az` module into the current user scope if it is not available).
- **Azure account access**: an account able to call Microsoft Graph and Azure DevOps APIs. Running `Connect-AzAccount` may be necessary.

**Quick Start / Usage**
1. Open a PowerShell prompt in the repository folder containing `IdentityChecker.ps1`.
2. Run the script interactively:

```
pwsh -File .\IdentityChecker.ps1
```

3. When prompted, enter your Azure DevOps organization name (short org name) and the UPN you want to check (e.g. `user@contoso.com`).

Notes:
- The script attempts to install the `Az` module if it is missing (it uses `Install-Module -Name Az -Scope CurrentUser`).
- The script uses `Get-AzAccessToken` to obtain tokens for Microsoft Graph and Azure DevOps endpoints.

**What the script prints**
- **Entra Tenant Info**: Tenant display name and tenant id.
- **Entra User Info**: UPN, email, OID, user type (Member/Guest), whether the user has the Guest Inviter role.
- **Azure DevOps User Info**: VSID, tenant id, account name, email, OID, and DevOps user type (Guest/Member/Unknown).
- **Checks and guidance**: The script runs and prints results for:
	- UPN casing mismatch (DevOps vs Entra)
	- OID mismatch
	- Tenant ID mismatch
	- User type mismatch (Guest vs Member)
	- Missing Guest Inviter role for guest users
	- Guest UPN/email mismatch and suggested remediation steps

**Common Troubleshooting**
- If a user is not found in Azure DevOps, verify the `OrgName` is correct and that the running account has permission to query the organization.
- If the script cannot obtain tokens, run `Connect-AzAccount` and ensure the account has appropriate permissions (Graph + DevOps). The script will also attempt to call `Install-Module` if `Az` is not present â€” run PowerShell as an Administrator if you encounter permission errors when installing modules.
- If you see tenant mismatches, verify the user is signing into the correct tenant (try a private browser session or confirm the tenant in the account info).
- For complex issues (OID or tenant mismatches that affect login), consider opening a Microsoft support case and include the script output.

**Extending / Contributing**
- The script is intentionally small and easy to extend. Suggested improvements already noted in the script include: deeper role checks, checks for Conditional Access / CAP-related failures, and additional handling for member users stuck as guests on the DevOps side.

**Files**
- `IdentityChecker.ps1`: Main script that performs all collection and checks.
- `LICENSE`: Repository license file.

**License & Support**
- See the repository `LICENSE` file for licensing details.
- For issues or feature requests, open an issue in the repository.

--
Generated by the repository owner to help diagnose identity issues between Microsoft Entra and Azure DevOps.
